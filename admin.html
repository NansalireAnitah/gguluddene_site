<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cultural Hub - Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  * { box-sizing: border-box; }
  body { margin:0; font-family:"Segoe UI", Arial, sans-serif; background:#f5f5f5; color:#333; }
  .topbar { background:#1976d2; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
  .menu-icon { font-size:22px; cursor:pointer; }
  .sidebar { position:fixed; left:-260px; top:0; width:250px; height:100%; background:#263238; color:#fff; padding:20px; transition:left 0.3s; z-index:1000; overflow-y:auto; }
  .sidebar.active { left:0; }
  .sidebar h2 { text-align:center; margin-bottom:30px; }
  .sidebar ul { list-style:none; padding:0; }
  .sidebar ul li { padding:12px 10px; margin-bottom:8px; background:#37474f; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:10px; transition: background 0.2s; }
  .sidebar ul li:hover { background:#455a64; }
  .content { padding:30px; margin-left:0; transition: margin-left 0.3s; }
  .sidebar.active ~ .content { margin-left:250px; }
  .card { background:#fff; padding:25px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:25px; }
  button { background:#1976d2; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; transition: background 0.2s; }
  button:hover { background:#0f62b5; }
  .users-table { width:100%; border-collapse:collapse; margin-top:10px; }
  .users-table th, .users-table td { border:1px solid #ccc; padding:10px; text-align:left; }
  .users-table th { background:#f0f0f0; }
  .edit-btn { background:#0288d1; color:#fff; margin-right:5px; }
  .delete-btn { background:crimson; color:#fff; }
  .toast { position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:6px; display:none; z-index:2000; min-width:200px; text-align:center; }
  .toast.success { background:#2e7d32; }
  .toast.error { background:#d32f2f; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:1200; }
  .modal-content { background:white; width:90%; max-width:500px; margin:60px auto; padding:20px; border-radius:10px; position:relative; box-shadow:0 2px 10px rgba(0,0,0,0.2); }
  .close-btn { position:absolute; top:10px; right:10px; font-size:18px; cursor:pointer; }
  .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-top:20px; }
  .stat-card { background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:20px; text-align:center; }
  .stat-card i { font-size:40px; margin-bottom:10px; color:#1976d2; }
  .stat-card h3 { margin:5px 0; font-size:22px; }
  .stat-card p { margin:0; color:#666; font-size:15px; }
  input, textarea, select { width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc; }
  img.blog-image { max-width:100%; margin-top:10px; border-radius:6px; }
</style>
</head>
<body>

<div class="topbar">
  <i class="fas fa-bars menu-icon" id="menuToggle"></i>
  <h1>Admin Dashboard</h1>
</div>

<div class="sidebar" id="sidebar">
  <h2>Menu</h2>
  <ul>
    <li onclick="showSection('start')"><i class="fas fa-home"></i> Dashboard Home</li>
    <li onclick="showSection('blogs')"><i class="fas fa-blog"></i> Manage Blogs</li>
    <li onclick="showSection('users')"><i class="fas fa-users"></i> Manage Users</li>
    <li onclick="showSection('reviews')"><i class="fas fa-comments"></i> User Reviews</li>
  </ul>
</div>

<div class="content">
  <!-- DASHBOARD HOME -->
  <div id="start" class="section card">
    <h2>Welcome, Admin ðŸ‘‹</h2>
    <p>Hereâ€™s a quick overview of Gguluddene Traditional Healers & Herbalists' Association.</p>
    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-users"></i>
        <h3 id="userCount">0</h3>
        <p>Total Users</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-blog"></i>
        <h3 id="blogCount">0</h3>
        <p>Total Blogs</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-comments"></i>
        <h3 id="reviewCount">0</h3>
        <p>Total Reviews</p>
      </div>
    </div>
  </div>

  <!-- BLOGS -->
  <div id="blogs" class="section card" style="display:none;">
    <h3>Manage Blogs</h3>
    <form id="blogForm" novalidate>
      <input type="text" id="blogTitle" placeholder="Blog Title" required>
      <textarea id="blogContent" rows="4" placeholder="Blog Content" required></textarea>
      <input type="text" id="blogCategory" placeholder="Category (optional)">
      <input type="file" id="blogImage" accept="image/*">
      <button type="submit" id="publishBtn">Publish Blog</button>
    </form>
    <h4>Existing Blogs</h4>
    <div id="blogsList"></div>
  </div>

  <!-- USERS -->
  <div id="users" class="section card" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Manage Users</h3>
      <button id="openAddUserModal">+ Add User</button>
    </div>
    <table class="users-table">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Status</th><th>Role</th><th>Actions</th></tr>
      </thead>
      <tbody id="usersList"></tbody>
    </table>
  </div>

  <!-- REVIEWS -->
  <div id="reviews" class="section card" style="display:none;">
    <h3>User Reviews</h3>
    <div id="reviewsList"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="toast"></div>

<!-- MODAL -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" id="closeModal">&times;</span>
    <h3 id="modalTitle">Add User</h3>
    <input type="text" id="modalName" placeholder="Name" required>
    <input type="email" id="modalEmail" placeholder="Email" required>
    <select id="modalRole">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <select id="modalStatus">
      <option value="approved">Approved</option>
      <option value="pending">Pending</option>
    </select>
    <button id="saveUserBtn">Save</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDwkxK1meIH0Ud2Pide0c9PQEsWebPWUvs",
  authDomain: "gguluddene.firebaseapp.com",
  projectId: "gguluddene",
  storageBucket: "gguluddene.appspot.com",
  messagingSenderId: "418864999337",
  appId: "1:418864999337:web:fb6468f95c6633b670b2b8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Sidebar toggle
const sidebar = document.getElementById("sidebar");
document.getElementById("menuToggle").onclick = ()=> sidebar.classList.toggle("active");

// Toast
const toast = document.getElementById("toast");
const showToast = (msg, type="success")=>{
  toast.textContent = msg;
  toast.className = `toast ${type}`;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3000);
};

// Auth check
onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="membership.html"; return; }
  const userRef = doc(db, "users", user.uid);
  const userDoc = await getDoc(userRef);
  if(!userDoc.exists() || userDoc.data().role!=="admin"){ window.location.href="index.html"; return; }
  showToast("âœ… Welcome Admin!");
  updateDashboardCounts();
});

// Navigation
window.showSection = (id)=>{
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  sidebar.classList.remove("active");
  if(id==="start") updateDashboardCounts();
  if(id==="users") loadUsers();
  if(id==="blogs") loadBlogs();
  if(id==="reviews") loadReviews();
};

// Dashboard counts
async function updateDashboardCounts(){
  const usersSnap = await getDocs(collection(db,"users"));
  const blogsSnap = await getDocs(collection(db,"blogs"));
  const reviewsSnap = await getDocs(collection(db,"reviews"));
  document.getElementById("userCount").textContent = usersSnap.size;
  document.getElementById("blogCount").textContent = blogsSnap.size;
  document.getElementById("reviewCount").textContent = reviewsSnap.size;
}

// BLOGS
const blogForm = document.getElementById("blogForm");
blogForm.addEventListener("submit", async (e)=>{
  e.preventDefault();

  const title = document.getElementById("blogTitle").value.trim();
  const content = document.getElementById("blogContent").value.trim();
  const category = document.getElementById("blogCategory").value.trim();

  if(!title || !content){
    showToast("Title and content are required","error");
    return;
  }

  try {
    let imageUrl = "";
    const file = document.getElementById("blogImage").files[0];
    if(file){
      const formData = new FormData();
      formData.append("image", file);

      const apiKey = "a76d491b3f50093fddaf42dcfaedc1c6"; 
      const response = await fetch(`https://api.imgbb.com/1/upload?key=${apiKey}`, {
        method: "POST",
        body: formData
      });
      const result = await response.json();
      if(result.success){
        imageUrl = result.data.url;
      } else {
        showToast("Image upload failed","error");
      }
    }

    await addDoc(collection(db,"blogs"), {
      title,
      content,
      category: category || "Uncategorized",
      imageUrl,
      createdAt: new Date()
    });

    blogForm.reset();
    showToast("Blog published successfully!");
    loadBlogs();
    updateDashboardCounts();
  } catch(err){
    console.error(err);
    showToast("Failed to publish blog.","error");
  }
});

async function loadBlogs(){
  const blogsDiv = document.getElementById("blogsList");
  blogsDiv.innerHTML="";
  const blogsSnap = await getDocs(query(collection(db,"blogs"), orderBy("createdAt","desc")));
  blogsSnap.forEach(blog=>{
    const b = blog.data();
    const div = document.createElement("div");
    div.style.border="1px solid #ccc"; 
    div.style.padding="10px"; 
    div.style.marginBottom="10px"; 
    div.style.borderRadius="6px";
    div.innerHTML = `
      <strong>${b.title}</strong> (${b.category || "Uncategorized"})<br>
      ${b.content}<br>
      ${b.imageUrl ? `<img src="${b.imageUrl}" class="blog-image">` : ""}
    `;
    const editBtn = document.createElement("button");
    editBtn.textContent = "Edit";
    editBtn.classList.add("edit-btn");
    editBtn.onclick = ()=> editBlog(blog.id);
    const delBtn = document.createElement("button");
    delBtn.textContent = "Delete";
    delBtn.classList.add("delete-btn");
    delBtn.onclick = ()=> deleteBlog(blog.id);
    div.appendChild(editBtn);
    div.appendChild(delBtn);
    blogsDiv.appendChild(div);
  });
}

async function editBlog(id){
  const docRef = doc(db,"blogs",id);
  const docSnap = await getDoc(docRef);
  if(!docSnap.exists()) return;
  const data = docSnap.data();
  const newTitle = prompt("Edit title", data.title);
  const newContent = prompt("Edit content", data.content);
  if(newTitle && newContent){
    await updateDoc(docRef,{title:newTitle,content:newContent});
    showToast("Blog updated!");
    loadBlogs();
  }
}

async function deleteBlog(id){
  if(confirm("Delete this blog?")){
    await deleteDoc(doc(db,"blogs",id));
    showToast("Blog deleted!");
    loadBlogs();
    updateDashboardCounts();
  }
}

// USERS
const userModal = document.getElementById("userModal");
const closeModal = document.getElementById("closeModal");
closeModal.onclick = ()=> userModal.style.display="none";
window.onclick = e => { if(e.target===userModal) userModal.style.display="none"; };

let editingUserId = null;
document.getElementById("openAddUserModal").onclick = ()=>{
  editingUserId = null;
  document.getElementById("modalTitle").textContent = "Add User";
  document.getElementById("modalName").value="";
  document.getElementById("modalEmail").value="";
  document.getElementById("modalRole").value="user";
  document.getElementById("modalStatus").value="approved";
  userModal.style.display="block";
};

document.getElementById("saveUserBtn").onclick = async ()=>{
  const name = document.getElementById("modalName").value.trim();
  const email = document.getElementById("modalEmail").value.trim();
  const role = document.getElementById("modalRole").value;
  const status = document.getElementById("modalStatus").value;
  if(!name || !email){ showToast("Please fill all fields","error"); return; }

  try {
    if(editingUserId){
      await updateDoc(doc(db,"users",editingUserId),{name,email,role,status});
      showToast("User updated!");
    }else{
      await addDoc(collection(db,"users"),{name,email,role,status});
      showToast("User added!");
    }
    userModal.style.display="none";
    loadUsers();
    updateDashboardCounts();
  } catch(err){
    showToast("Error saving user","error");
    console.error(err);
  }
};

async function loadUsers(){
  const tbody = document.getElementById("usersList");
  tbody.innerHTML="";
  const usersSnap = await getDocs(collection(db,"users"));
  usersSnap.forEach(u=>{
    const d = u.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.name}</td>
      <td>${d.email}</td>
      <td>${d.status}</td>
      <td>${d.role}</td>
      <td>
        <button class="edit-btn">Manage</button>
      </td>
    `;
    tr.querySelector(".edit-btn").addEventListener("click", ()=>{
      editingUserId = u.id;
      document.getElementById("modalTitle").textContent = "Edit User";
      document.getElementById("modalName").value = d.name;
      document.getElementById("modalEmail").value = d.email;
      document.getElementById("modalRole").value = d.role;
      document.getElementById("modalStatus").value = d.status;
      userModal.style.display="block";
    });
    tbody.appendChild(tr);
  });
}

// REVIEWS
async function loadReviews(){
  const div = document.getElementById("reviewsList");
  div.innerHTML="";
  const reviewsSnap = await getDocs(collection(db,"reviews"));
  reviewsSnap.forEach(r=>{
    const data = r.data();
    const reviewDiv = document.createElement("div");
    reviewDiv.style.border="1px solid #ccc"; 
    reviewDiv.style.padding="10px"; 
    reviewDiv.style.marginBottom="10px"; 
    reviewDiv.style.borderRadius="6px";
    reviewDiv.innerHTML = `<strong>${data.userName}</strong>: ${data.message}`;
    div.appendChild(reviewDiv);
  });
}
</script>
</body>
</html>
