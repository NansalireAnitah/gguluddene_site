<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cultural Hub - Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  * { box-sizing: border-box; }
  body { margin:0; font-family:"Segoe UI", Arial, sans-serif; background:#f5f5f5; color:#333; }
  .topbar { background:#1976d2; color:#fff; padding:15px 20px; display:flex; justify-content:space-between; align-items:center; }
  .menu-icon { font-size:22px; cursor:pointer; }
  .sidebar { position:fixed; left:-260px; top:0; width:250px; height:100%; background:#263238; color:#fff; padding:20px; transition:left 0.3s; z-index:1000; }
  .sidebar.active { left:0; }
  .sidebar h2 { text-align:center; margin-bottom:30px; }
  .sidebar ul { list-style:none; padding:0; }
  .sidebar ul li { padding:12px 10px; margin-bottom:8px; background:#37474f; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:10px; }
  .sidebar ul li:hover { background:#455a64; }
  .content { padding:30px; margin-left:0; transition: margin-left 0.3s; }
  .sidebar.active ~ .content { margin-left:250px; }
  .card { background:#fff; padding:25px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:25px; }
  button { background:#1976d2; color:white; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; }
  button:hover { background:#0f62b5; }
  .users-table { width:100%; border-collapse:collapse; margin-top:10px; }
  .users-table th, .users-table td { border:1px solid #ccc; padding:10px; }
  .users-table th { background:#f0f0f0; }
  .edit-btn { background:#0288d1; color:#fff; }
  .delete-btn { background:crimson; color:#fff; }
  .toast { position:fixed; top:20px; right:20px; background:#333; color:white; padding:15px; border-radius:6px; display:none; z-index:2000; }
  .toast.success { background:#2e7d32; }
  .toast.error { background:#d32f2f; }
  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:1200; }
  .modal-content { background:white; width:90%; max-width:500px; margin:60px auto; padding:20px; border-radius:10px; position:relative; }
  .close-btn { position:absolute; top:10px; right:10px; font-size:18px; cursor:pointer; }
  .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:20px; margin-top:20px; }
  .stat-card { background:white; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:20px; text-align:center; }
  .stat-card i { font-size:40px; margin-bottom:10px; color:#1976d2; }
  .stat-card h3 { margin:5px 0; font-size:22px; }
  .stat-card p { margin:0; color:#666; font-size:15px; }
  input, select, textarea { width:100%; padding:8px; margin:5px 0; border-radius:6px; border:1px solid #ccc; }
</style>
</head>
<body>

<div class="topbar">
  <i class="fas fa-bars menu-icon" id="menuToggle"></i>
  <h1>Admin Dashboard</h1>
</div>

<div class="sidebar" id="sidebar">
  <h2>Menu</h2>
  <ul>
    <li onclick="showSection('start')"><i class="fas fa-home"></i> Dashboard Home</li>
    <li onclick="showSection('blogs')"><i class="fas fa-blog"></i> Manage Blogs</li>
    <li onclick="showSection('users')"><i class="fas fa-users"></i> Manage Users</li>
    <li onclick="showSection('reviews')"><i class="fas fa-comments"></i> User Reviews</li>
  </ul>
</div>

<div class="content">
  <!-- DASHBOARD -->
  <div id="start" class="section card">
    <h2>Welcome, Admin ðŸ‘‹</h2>
    <p>Hereâ€™s a quick overview of Gguluddene Traditional Healers & Herbalists' Association.</p>
    <div class="stats-grid">
      <div class="stat-card">
        <i class="fas fa-users"></i>
        <h3 id="userCount">0</h3>
        <p>Total Users</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-blog"></i>
        <h3 id="blogCount">0</h3>
        <p>Total Blogs</p>
      </div>
      <div class="stat-card">
        <i class="fas fa-comments"></i>
        <h3 id="reviewCount">0</h3>
        <p>Total Reviews</p>
      </div>
    </div>
  </div>

  <!-- BLOGS -->
  <div id="blogs" class="section card" style="display:none;">
    <h3>Manage Blogs</h3>
    <form id="blogForm">
      <input type="text" id="blogTitle" placeholder="Blog Title" required><br><br>
      <textarea id="blogContent" rows="4" placeholder="Blog Content" required></textarea><br><br>
      <input type="text" id="blogCategory" placeholder="Category"><br><br>
      <button type="submit">Publish Blog</button>
    </form>
    <h4>Existing Blogs</h4>
    <div id="blogsList"></div>
  </div>

  <!-- USERS -->
  <div id="users" class="section card" style="display:none;">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Manage Users</h3>
      <button id="openAddUserModal">+ Add User</button>
    </div>
    <table class="users-table">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Status</th><th>Role</th><th>Actions</th></tr>
      </thead>
      <tbody id="usersList"></tbody>
    </table>
  </div>

  <!-- REVIEWS -->
  <div id="reviews" class="section card" style="display:none;">
    <h3>User Reviews</h3>
    <div id="reviewsList"></div>
  </div>
</div>

<!-- Add/Edit User Modal -->
<div class="modal" id="userModal">
  <div class="modal-content">
    <span class="close-btn" id="closeUserModal">&times;</span>
    <h3 id="modalTitle">Add/Edit User</h3>
    <input type="text" id="modalUserName" placeholder="Name">
    <input type="email" id="modalUserEmail" placeholder="Email">
    <select id="modalUserStatus">
      <option value="approved">Approved</option>
      <option value="pending">Pending</option>
    </select>
    <select id="modalUserRole">
      <option value="user">User</option>
      <option value="admin">Admin</option>
    </select>
    <button id="saveUserBtn">Save</button>
    <button id="deleteUserBtn" style="background:crimson;color:white;display:none;">Delete</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDwkxK1meIH0Ud2Pide0c9PQEsWebPWUvs",
  authDomain: "gguluddene.firebaseapp.com",
  projectId: "gguluddene",
  storageBucket: "gguluddene.firebasestorage.app",
  messagingSenderId: "418864999337",
  appId: "1:418864999337:web:fb6468f95c6633b670b2b8"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const sidebar = document.getElementById("sidebar");
document.getElementById("menuToggle").onclick = ()=> sidebar.classList.toggle("active");

const toast = document.getElementById("toast");
const showToast = (msg, type="success")=>{
  toast.textContent = msg;
  toast.className = `toast ${type}`;
  toast.style.display="block";
  setTimeout(()=>toast.style.display="none",3000);
};

onAuthStateChanged(auth, async (user)=>{
  if(!user){ window.location.href="membership.html"; return; }
  const userRef = doc(db, "users", user.uid);
  const userDoc = await getDoc(userRef);
  if(!userDoc.exists() || userDoc.data().role!=="admin"){ window.location.href="index.html"; return; }
  showToast("âœ… Welcome Admin!");
  updateDashboardCounts();
});

window.showSection = (id)=>{
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
  sidebar.classList.remove("active");
  if(id==="start") updateDashboardCounts();
  if(id==="users") loadUsers();
  if(id==="blogs") loadBlogs();
  if(id==="reviews") loadReviews();
};

// ---------- DASHBOARD ----------
async function updateDashboardCounts(){
  const usersSnap = await getDocs(collection(db,"users"));
  const blogsSnap = await getDocs(collection(db,"blogs"));
  const reviewsSnap = await getDocs(collection(db,"reviews"));
  document.getElementById("userCount").textContent = usersSnap.size;
  document.getElementById("blogCount").textContent = blogsSnap.size;
  document.getElementById("reviewCount").textContent = reviewsSnap.size;
}

// ---------- BLOGS ----------
const blogForm = document.getElementById("blogForm");
blogForm.addEventListener("submit", async (e)=>{
  e.preventDefault();
  await addDoc(collection(db,"blogs"), {
    title: blogForm.blogTitle.value,
    content: blogForm.blogContent.value,
    category: blogForm.blogCategory.value,
    createdAt: new Date()
  });
  blogForm.reset();
  showToast("Blog published!");
  loadBlogs();
  updateDashboardCounts();
});

async function loadBlogs(){
  const blogsDiv = document.getElementById("blogsList");
  blogsDiv.innerHTML="";
  const blogsSnap = await getDocs(collection(db,"blogs"));
  blogsSnap.forEach(blog=>{
    const b = blog.data();
    const div = document.createElement("div");
    div.style.border="1px solid #ccc"; div.style.padding="10px"; div.style.marginBottom="10px";
    div.innerHTML = `<strong>${b.title}</strong> (${b.category})<br>${b.content}<br>
      <button onclick='editBlog("${blog.id}")'>Edit</button>
      <button onclick='deleteBlog("${blog.id}")'>Delete</button>`;
    blogsDiv.appendChild(div);
  });
}

async function editBlog(id){
  const docRef = doc(db,"blogs",id);
  const docSnap = await getDoc(docRef);
  if(!docSnap.exists()) return;
  const data = docSnap.data();
  const newTitle = prompt("Edit title", data.title);
  const newContent = prompt("Edit content", data.content);
  if(newTitle && newContent){
    await updateDoc(docRef,{title:newTitle,content:newContent});
    showToast("Blog updated!");
    loadBlogs();
  }
}

async function deleteBlog(id){
  if(confirm("Delete this blog?")){
    await deleteDoc(doc(db,"blogs",id));
    showToast("Blog deleted!");
    loadBlogs();
    updateDashboardCounts();
  }
}

// ---------- USERS ----------
let selectedUserId = null;
const userModal = document.getElementById("userModal");
const modalUserName = document.getElementById("modalUserName");
const modalUserEmail = document.getElementById("modalUserEmail");
const modalUserStatus = document.getElementById("modalUserStatus");
const modalUserRole = document.getElementById("modalUserRole");
const saveUserBtn = document.getElementById("saveUserBtn");
const deleteUserBtn = document.getElementById("deleteUserBtn");
document.getElementById("closeUserModal").onclick = ()=> userModal.style.display="none";

document.getElementById("openAddUserModal").onclick = ()=>{
  selectedUserId = null;
  modalUserName.value = "";
  modalUserEmail.value = "";
  modalUserStatus.value = "approved";
  modalUserRole.value = "user";
  saveUserBtn.textContent = "Add User";
  deleteUserBtn.style.display = "none";
  userModal.style.display = "block";
};

saveUserBtn.onclick = async ()=>{
  const data = {
    name: modalUserName.value,
    email: modalUserEmail.value,
    status: modalUserStatus.value,
    role: modalUserRole.value
  };
  if(!data.name || !data.email) { showToast("Fill all fields","error"); return; }

  if(selectedUserId){
    await updateDoc(doc(db,"users",selectedUserId),data);
    showToast("User updated!");
  } else {
    await addDoc(collection(db,"users"),data);
    showToast("New user added!");
  }
  userModal.style.display="none";
  loadUsers();
  updateDashboardCounts();
};

deleteUserBtn.onclick = async ()=>{
  if(selectedUserId && confirm("Delete this user?")){
    await deleteDoc(doc(db,"users",selectedUserId));
    showToast("User deleted!");
    userModal.style.display="none";
    loadUsers();
    updateDashboardCounts();
  }
};

async function loadUsers(){
  const tbody = document.getElementById("usersList");
  tbody.innerHTML="";
  const usersSnap = await getDocs(collection(db,"users"));
  usersSnap.forEach(u=>{
    const d = u.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.name}</td><td>${d.email}</td><td>${d.status}</td><td>${d.role}</td>
      <td>
        <button class="edit-btn" onclick='editUser("${u.id}")'>Manage</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function editUser(id){
  selectedUserId = id;
  const docSnap = await getDoc(doc(db,"users",id));
  if(!docSnap.exists()) return;
  const data = docSnap.data();
  modalUserName.value = data.name;
  modalUserEmail.value = data.email;
  modalUserStatus.value = data.status;
  modalUserRole.value = data.role;
  saveUserBtn.textContent="Save Changes";
  deleteUserBtn.style.display="inline-block";
  userModal.style.display="block";
}

// ---------- REVIEWS ----------
async function loadReviews(){
  const div = document.getElementById("reviewsList");
  div.innerHTML="";
  const reviewsSnap = await getDocs(collection(db,"reviews"));
  reviewsSnap.forEach(r=>{
    const d = r.data();
    const rdiv = document.createElement("div");
    rdiv.style.border="1px solid #ccc"; rdiv.style.padding="10px"; rdiv.style.marginBottom="10px";
    rdiv.innerHTML = `<strong>${d.user}</strong>: ${d.comment} <em>(${d.date || ''})</em>`;
    div.appendChild(rdiv);
  });
}
</script>

</body>
</html>
